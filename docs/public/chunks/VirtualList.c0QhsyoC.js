import{p as F,a as K,b as U,O as ne}from"./ObserverItem.Ik21bs68.js";import{h as R,a7 as ee,a1 as fe,j as ae,a9 as ce,G as de,y as te,d as ue,a6 as k}from"./framework.UVXzjgAp.js";const ye={fixed:!1,buffer:0,bufferTop:0,bufferBottom:0,scrollDistance:0,horizontal:!1,start:0,offset:0,listStyle:"",listClass:"",itemStyle:"",itemClass:"",headerClass:"",headerStyle:"",footerClass:"",footerStyle:"",stickyHeaderClass:"",stickyHeaderStyle:"",stickyFooterClass:"",stickyFooterStyle:""};function Se(E,c){const e=new Proxy(E,{get(i,l){return Reflect.get(i,l)??Reflect.get(ye,l)}}),d=R(null),z=R(null),g=R(null),m=R(null),v=R(null),w=R(null),b=new Map,D=R(0);let B="backward",C=!1,I=!1;const r=ee({clientSize:0,headerSize:0,footerSize:0,stickyHeaderSize:0,stickyFooterSize:0}),t=ee({views:0,offset:0,listTotalSize:0,virtualSize:0,inViewBegin:0,inViewEnd:0,renderBegin:0,renderEnd:0,bufferTop:0,bufferBottom:0});function H(){const i=e.horizontal?"scrollLeft":"scrollTop";return d.value?d.value[i]:0}function j(){return r.headerSize+r.footerSize+r.stickyHeaderSize+r.stickyFooterSize}function _(){return t.listTotalSize+r.headerSize+r.footerSize+r.stickyHeaderSize+r.stickyFooterSize}function y(i){return e.fixed?e.minSize:b.get(String(i))??e.minSize}function G(i,l){b.set(String(i),l)}function P(i){b.delete(String(i))}function T(i){var o,u;if(e.fixed)return{top:e.minSize*i,current:e.minSize,bottom:e.minSize*(i+1)};const{itemKey:l}=e;let s=r.headerSize;for(let a=0;a<=i-1;a+=1){const x=y((o=e.list[a])==null?void 0:o[l]);s+=x}const n=y((u=e.list[i])==null?void 0:u[l]);return{top:s,current:n,bottom:s+n}}function S(i,l=!1){l&&(I=!0);const s=e.horizontal?"scrollLeft":"scrollTop";d.value&&(d.value[s]=i)}async function L(i){if(console.log("scrollToIndex",i),i<0)return;if(i>=e.list.length-1){$();return}let{top:l}=T(i);const s=async()=>{S(l),setTimeout(()=>{const{top:n}=T(i);l!==n&&(l=n,s())},3)};s()}async function q(i){var a;const{top:l,bottom:s}=T(i),n=H(),o=H()+r.clientSize,u=y((a=e.list[i])==null?void 0:a[e.itemKey]);if(l<n&&n<s&&u<r.clientSize){S(l);return}if(l+r.stickyHeaderSize<o&&o<s+r.stickyHeaderSize&&u<r.clientSize){S(s-r.clientSize+r.stickyHeaderSize);return}if(l+r.stickyHeaderSize>=o){L(i);return}if(s<=n){L(i);return}}async function A(){S(0),setTimeout(()=>{var l;const i=e.horizontal?"scrollLeft":"scrollTop";((l=d==null?void 0:d.value)==null?void 0:l[i])!==0&&A()},3)}async function $(){S(_()),setTimeout(()=>{Math.abs(Math.round(t.offset+r.clientSize)-Math.round(_()))>2&&$()},0)}function V(i){t.inViewBegin=i,t.inViewEnd=Math.min(i+t.views,e.list.length-1)}function p(){var x,O;const{views:i,offset:l,inViewBegin:s}=t,{itemKey:n}=e,o=l-r.headerSize;let u=s,a=re();if(o<0){V(0);return}if(B==="forward"){if(o>=a)return;for(let h=u-1;h>=0;h-=1){const N=y((x=e.list[h])==null?void 0:x[n]);if(a-=N,a<=o&&o<a+N){u=h;break}}C=!0}if(B==="backward"){if(o<=a)return;for(let h=u;h<=e.list.length-1;h+=1){const N=y((O=e.list[h])==null?void 0:O[n]);if(a<=o&&o<a+N){u=h;break}a+=N}C=!1}u!==t.inViewBegin&&V(u)}function M(i){var s,n,o;(s=c==null?void 0:c.scroll)==null||s.call(c,i);const l=H();l!==t.offset&&(B=l<t.offset?"forward":"backward",t.offset=l,p(),B==="forward"&&t.offset-e.scrollDistance<=0&&(console.log("[VirtualList] 到达顶部"),(n=c==null?void 0:c.toTop)==null||n.call(c,e.list[0])),B==="backward"&&t.offset+e.scrollDistance>=t.listTotalSize+j()-r.clientSize&&(console.log("[VirtualList] 到达底部"),(o=c==null?void 0:c.toBottom)==null||o.call(c,e.list[e.list.length-1])))}function ie(){const i=Math.ceil(r.clientSize/e.minSize)+1;t.views=i}function le(){ie(),V(t.inViewBegin)}function W(){var s;if(e.fixed){t.listTotalSize=e.minSize*e.list.length;return}const{itemKey:i}=e;let l=0;for(let n=0;n<=e.list.length-1;n+=1)l+=y((s=e.list[n])==null?void 0:s[i]);t.listTotalSize=l}function Q(){console.log("[VirtualList] reset"),t.offset=0,t.listTotalSize=0,t.virtualSize=0,t.inViewBegin=0,t.inViewEnd=0,t.renderBegin=0,t.renderEnd=0,b.clear()}function oe(i){W();let l=0;i.forEach(s=>{l+=y(s[e.itemKey])}),Y(),S(t.offset-l,!0),p()}function se(i){W();let l=0;i.forEach(s=>{l+=y(s[e.itemKey])}),Y(),S(t.offset+l,!0),p()}function X(){D.value+=1}let f;typeof ResizeObserver<"u"&&(f=new ResizeObserver(i=>{var s;let l=0;for(const n of i){const o=n.target.dataset.id;if(o){const u=y(o),a=e.horizontal?n.borderBoxSize[0].inlineSize:n.borderBoxSize[0].blockSize;o==="client"?(r.clientSize=a,le()):o==="header"?r.headerSize=a:o==="footer"?r.footerSize=a:o==="stickyHeader"?r.stickyHeaderSize=a:o==="stickyFooter"?r.stickyFooterSize=a:u!==a&&(G(o,a),l+=a-u,(s=c==null?void 0:c.itemResize)==null||s.call(c,o,a))}}t.listTotalSize+=l,(C||I)&&l!==0&&(C=!1,I=!1,S(t.offset+l))}));const Y=()=>{var s;let i=0;const l=t.inViewBegin;for(let n=0;n<l;n++)i+=y((s=e.list[n])==null?void 0:s[e.itemKey]);t.virtualSize=i};fe(()=>{e.bufferTop?t.bufferTop=e.bufferTop:t.bufferTop=e.buffer,e.bufferBottom?t.bufferBottom=e.bufferBottom:t.bufferBottom=e.buffer}),ae(()=>{d.value&&(d.value.addEventListener("scroll",M),f==null||f.observe(d.value)),v.value&&(f==null||f.observe(v.value)),w.value&&(f==null||f.observe(w.value)),g.value&&(f==null||f.observe(g.value)),m.value&&(f==null||f.observe(m.value)),e.start?L(e.start):e.offset&&S(e.offset)}),ce(()=>{d.value&&(d.value.removeEventListener("scroll",M),f==null||f.unobserve(d.value),r.clientSize=0),v.value&&(f==null||f.unobserve(v.value),r.stickyHeaderSize=0),w.value&&(f==null||f.unobserve(w.value),r.stickyFooterSize=0),g.value&&(f==null||f.unobserve(g.value),r.headerSize=0),m.value&&(f==null||f.unobserve(m.value),r.footerSize=0)});function re(){return t.virtualSize+J(t.renderBegin,t.inViewBegin)}function J(i,l){var u;const s=Math.min(i,l),n=Math.max(i,l);let o=0;for(let a=s;a<n;a+=1)o+=y((u=e.list[a])==null?void 0:u[e.itemKey]);return o}const Z=de([]);return te(()=>[t.inViewBegin,t.inViewEnd,D.value],(i,l)=>{if(i&&l){const[s]=i,n=t.renderBegin;let o=s,u=t.inViewEnd;if(o=Math.max(0,o-t.bufferTop),u=Math.min(u+t.bufferBottom,e.list.length-1),e!=null&&e.renderControl){const{begin:a,end:x}=e.renderControl(s,t.inViewEnd);o=a,u=x}t.renderBegin=o,t.renderEnd=u,o>n?t.virtualSize+=J(o,n):t.virtualSize-=J(o,n),Z.value=e.list.slice(t.renderBegin,t.renderEnd+1)}},{immediate:!0}),te(()=>e.list.length,()=>{if(e.list.length<=0){Q();return}W(),V(t.inViewBegin),X()},{immediate:!0}),{props:e,renderList:Z,clientRefEl:d,listRefEl:z,headerRefEl:g,footerRefEl:m,stickyHeaderRefEl:v,stickyFooterRefEl:w,reactiveData:t,slotSize:r,sizesMap:b,resizeObserver:f,getOffset:H,reset:Q,scrollToIndex:L,scrollIntoView:q,scrollToTop:A,scrollToBottom:$,scrollToOffset:S,getItemSize:y,deleteItemSize:P,deletedList2Top:oe,addedList2Top:se,getItemPosByIndex:T,forceUpdate:X}}const ge=ue({name:"VirtualList",props:{list:{type:Array,default:()=>[]},itemKey:{type:[String,Number],required:!0},minSize:{type:Number,default:20,required:!0},renderControl:{type:Function,default:void 0},fixed:{type:Boolean,default:!1},buffer:{type:Number,default:0},bufferTop:{type:Number,default:0},bufferBottom:{type:Number,default:0},scrollDistance:{type:Number,default:0},horizontal:{type:Boolean,default:!1},start:{type:Number,default:0},offset:{type:Number,default:0},listStyle:{type:String,default:""},listClass:{type:String,default:""},itemStyle:{type:String,default:""},itemClass:{type:String,default:""},headerClass:{type:String,default:""},headerStyle:{type:String,default:""},footerClass:{type:String,default:""},footerStyle:{type:String,default:""},stickyHeaderClass:{type:String,default:""},stickyHeaderStyle:{type:String,default:""},stickyFooterClass:{type:String,default:""},stickyFooterStyle:{type:String,default:""}},setup(E,c){return Se(E,{scroll:d=>{c.emit("scroll",d)},toTop:d=>{c.emit("toTop",d)},toBottom:d=>{c.emit("toBottom",d)},itemResize:(d,z)=>{c.emit("itemResize",d,z)}})},render(){const{renderList:E,reactiveData:c,resizeObserver:e}=this,{itemKey:d,horizontal:z,listStyle:g,listClass:m,itemStyle:v,itemClass:w,headerClass:b,headerStyle:D,footerClass:B,footerStyle:C,stickyHeaderClass:I,stickyHeaderStyle:r,stickyFooterClass:t,stickyFooterStyle:H}=this.props,j=()=>this.$slots.stickyHeader?k("div",K({key:"slot-sticky-header",class:I,style:`position: sticky; z-index: 10; ${z?"left: 0":"top: 0;"} ${r}`,ref:"stickyHeaderRefEl"},{"data-id":"stickyHeader"}),[U(this.$slots.stickyHeader)]):null,_=()=>this.$slots.stickyFooter?k("div",K({key:"slot-sticky-footer",class:t,style:`position: sticky; z-index: 10; ${z?"right: 0":"bottom: 0;"} ${H}`,ref:"stickyFooterRefEl"},{"data-id":"stickyFooter"}),[U(this.$slots.stickyFooter)]):null,y=()=>this.$slots.header?k("div",K({key:"slot-header",class:b,style:D,ref:"headerRefEl"},{"data-id":"header"}),[U(this.$slots.header)]):null,G=()=>this.$slots.footer?k("div",K({key:"slot-footer",class:B,style:C,ref:"footerRefEl"},{"data-id":"footer"}),[U(this.$slots.footer)]):null,{listTotalSize:P,virtualSize:T,renderBegin:S}=c,L=()=>{var $,V;const q=[];for(let p=0;p<E.length;p+=1){const M=E[p];q.push(k(ne,K({key:M[d],class:w,style:v},{id:M[d],resizeObserver:e}),F([(V=($=this.$slots).default)==null?void 0:V.call($,{itemData:M,index:S+p})])))}const A=z?`will-change: width; min-width: ${P}px; display: flex; ${g}`:`will-change: height; min-height: ${P}px; ${g}`;return k("div",{ref:"listRefEl",class:m,style:A},[k("div",{style:z?`width: ${T}px; will-change: width;`:`height: ${T}px; will-change: height;`}),q])};return k("div",K({ref:"clientRefEl",class:"virtual-list__client",style:"width: 100%; height: 100%; overflow: overlay;"},{"data-id":"client"}),F([j(),y(),L(),G(),_()]))}});export{ge as V,Se as u};
